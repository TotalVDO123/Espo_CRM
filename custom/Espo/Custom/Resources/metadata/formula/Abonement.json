{
    "beforeSaveCustomScript": "// only once\n// [ name, price, classCount ]\nif (entity\\isNew()) {\n    $firstLatter = string\\substring(contact.firstName, 0, 1); \n    name = string\\concatenate(contact.firstName, ' ', contact.lastName);\n    \n    //discount and price\n    if (discountId) {\n        if (discount.isInUAH) {\n            price = abonplan.price - discount.amount;\n        } else {\n            $discount = (abonplan.price / 100) * discount.percent;\n            price = abonplan.price - $discount;\n        }\n    } else {\n        price = abonplan.price;   \n    }\n    \n    //forwarding\n    classCount = abonplan.classCount;\n    classesLeft = abonplan.classCount;\n    \n    //creating from attendace-sheet.js\n    if (isActivated == true) {\n        isActive = true;\n        activationDateTime = datetime\\now();\n        endDate = datetime\\addDays(startDate, abonplan.durationInDays - 1);\n    }\n    \n    isInitialized = true;\n} else {\n    //abonement-activate.js part \n    if (entity\\isAttributeChanged(\"isActivated\")) {\n        //set fields after activation\n        if (entity\\attribute(\"isActivated\") == true) {\n            activationDateTime = datetime\\now();\n            endDate = datetime\\addDays(startDate, abonplan.durationInDays - 1);\n        }\n    }\n    \n    //abonement-freeze.js part\n    if (entity\\isAttributeChanged(\"isFreezed\")) {\n        //after freeze button pressed\n        if (entity\\attribute(\"isFreezed\") == true) {\n            freezeDate = datetime\\today();\n            freezeDaysLeft = datetime\\diff(endDate, datetime\\today(), \"days\");\n        } else if (entity\\attribute(\"isFreezed\") == false) {\n            endDate = datetime\\addDays(datetime\\today(), freezeDaysLeft);\n        }\n    }\n    \n    //class left calculation\n    classesLeft = abonplan.classCount - record\\count('Mark', 'abonementId', id);\n    \n    //is active status setting\n    $isClassesNotUsed = classesLeft > 0;\n    $isNotExpired = datetime\\today() <= endDate;\n    \n    if (isPaid && isActivated && $isClassesNotUsed && $isNotExpired && !isFreezed) {\n        isActive = true;\n    } else {\n        isActive = false;\n    }\n}"
}